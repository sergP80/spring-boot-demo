<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd"
                   logicalFilePath="changelog/migration/R-1.0.2/1.0.2.0.xml">


    <changeSet id="1.0.2.0.0" author="andrii petrov">
        <preConditions onFail="MARK_RAN">
            <not>
                <customPrecondition className="liquibase.precondition.custom.CreateEnumPrecondition">
                    <param name="schemaName" value="library"/>
                    <param name="typeName" value="BookStatus"/>
                </customPrecondition>
            </not>
        </preConditions>

        <!-- Create the ENUM type -->
        <sql>
            CREATE TYPE library.BookStatus AS ENUM ('AVAILABLE', 'BORROWED');
        </sql>

        <rollback>
            DROP TYPE library.BookStatus;
        </rollback>
    </changeSet>

    <changeSet id="1.0.2.0.1" author="andrii petrov">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="library"  tableName="client"/>
            </not>
        </preConditions>

        <createSequence schemaName="library" sequenceName="client_id_seq" startValue="1" incrementBy="1" cycle="false" cacheSize="10"/>

        <createTable schemaName="library" tableName="client">
            <column name="id" type="int" defaultValueComputed="nextval('library.client_id_seq')">
                <constraints primaryKeyName="pk_client" primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(256)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="varchar(1024)"/>
            <column name="email" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="phone" type="varchar(128)"/>
        </createTable>

        <rollback>
            <dropTable schemaName="library" tableName="client"/>
            <dropSequence schemaName="library" sequenceName="client_id_seq"/>
        </rollback>
    </changeSet>

    <changeSet id="1.0.2.0.2" author="andrii petrov">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="library"  tableName="history"/>
            </not>
        </preConditions>

        <createSequence schemaName="library" sequenceName="history_id_seq" startValue="1" incrementBy="1" cycle="false" cacheSize="10"/>

        <createTable schemaName="library" tableName="history">
            <column name="id" type="int" defaultValueComputed="nextval('library.history_id_seq')">
                <constraints primaryKeyName="pk_history" primaryKey="true" nullable="false"/>
            </column>
            <column name="client_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_history_client" references="library.client(id)"/>
            </column>
            <column name="status" type="varchar(50)" defaultValue="AVAILABLE">
                <constraints nullable="false"/>
            </column>
            <column name="borrowed_at" type="date"/>
            <column name="returned_at" type="date"/>
            <column name="book_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_history_book" references="library.book(id)"/>
            </column>
        </createTable>

        <rollback>
            <dropTable schemaName="library" tableName="history"/>
            <dropSequence schemaName="library" sequenceName="history_id_seq"/>
        </rollback>
    </changeSet>
    <changeSet id="1.0.2.0.3" author="andrii petrov">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists schemaName="library"  tableName="booked"/>
            </not>
        </preConditions>

        <createSequence schemaName="library" sequenceName="booked_id_seq" startValue="1" incrementBy="1" cycle="false" cacheSize="10"/>

        <createTable schemaName="library" tableName="booked">
            <column name="id" type="int" defaultValueComputed="nextval('library.booked_id_seq')">
                <constraints primaryKeyName="pk_booked" primaryKey="true" nullable="false"/>
            </column>
            <column name="client_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_booked_client" references="library.client(id)"/>
            </column>
            <column name="status" type="varchar(50)" defaultValue="BORROWED">
                <constraints nullable="false"/>
            </column>
            <column name="borrowed_at" type="date"/>
            <column name="book_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_booked_book" references="library.book(id)"/>
            </column>
        </createTable>

        <rollback>
            <dropTable schemaName="library" tableName="history"/>
            <dropSequence schemaName="library" sequenceName="history_id_seq"/>
        </rollback>
    </changeSet>
    <changeSet id="1.0.2.0.4" author="andrii petrov">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists schemaName="library" tableName="book" columnName="status"/>
            </not>
        </preConditions>

        <addColumn tableName="book" schemaName="library">
            <column name="status" type="varchar(50)" defaultValue="AVAILABLE">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn columnName="status" tableName="book" schemaName="library"/>
        </rollback>
    </changeSet>
</databaseChangeLog>